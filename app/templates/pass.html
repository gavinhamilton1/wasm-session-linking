<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Pass</title>
    <link rel="stylesheet" href="/static/css/scanner.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script type="module">
        import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";
        import * as Base64 from "/apriltag/base64.js";
    
        async function initAprilTag() {
            const ApriltagWorker = Comlink.wrap(new Worker("/apriltag/apriltag.js"));
            window.apriltag = await new ApriltagWorker(Comlink.proxy(() => {
                window.apriltag.set_tag_size(5, 0.5);
            }));
            console.log("AprilTag Detector is ready");
        }
        initAprilTag();
    </script>

</head>
<body>
    <div class="container">
        <h2>Please Scan QR Code</h2>
        <div class="camera-section">
            <video id="camera" playsinline autoplay></video>
            <canvas id="canvas"></canvas>
            <div class="scan-region"></div>
            <div id="status" class="status"></div>
            
            <video id="qr-video" autoplay></video>
            <canvas id="frame-canvas"</canvas>
        </div>
        <div class="data-section">
        <div id="qr-data"></div>
        <div id="april-tags"></div>

    </div>

    <script>
        let scanning = false;
        const video = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const frameCanvas = document.getElementById("frame-canvas");
        const context = canvas.getContext("2d", { willReadFrequently: true });
        const frameContext = frameCanvas.getContext("2d", { willReadFrequently: true });
  
        const captureMax = 2;
        let captureCount = 0;
        let qrData = "";
        let aprilTags = [];
        let frameList = [];
        // Initialize WebSocket and other components after DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                document.getElementById("resetButton").addEventListener("click", () => {
                    console.log("📤 Sending Reset Command...");
                    window.ws.send(JSON.stringify({ type: "reset" }));
                    resetCanvas();
                });
            
                // Start camera after a delay
                await setTimeout(startCamera, 100);      
                    
            } catch (error) {
                console.error("Initialization error:", error);
            }
        });
        
        function resetCanvas() {
            const canvas = document.getElementById("signatureCanvas");
            if (!canvas) {
                console.error("❌ Canvas not found!");
                return;
            } else {
                canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        async function startCamera() {
            try {
                document.querySelector('.camera-section').style.display = "block";
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 },
                        colorSpace: "srgb" 
                    }
                });

                video.addEventListener("loadedmetadata", () => {
                    frameCanvas.width = video.videoWidth;
                    frameCanvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
                                
                video.srcObject = stream;
                await video.play();
                scanning = true;
                canvas.width = 1280;
                canvas.height = 720;
                frameCanvas.width = video.videoWidth;
                frameCanvas.height = video.videoHeight;
                //frameContext.filter = "grayscale(100%)";

                await scanForQRCode();
            } catch (err) {
                console.error("Camera access denied:", err);
            }
        }

        async function scanForQRCode() {
            if (!scanning) return;
        
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        
                    if (code && code.data) {
                        // check if the data starts with https, and is so parse after data=
                        if (code.data.startsWith("https://")) {
                            qrData = code.data.split("data=")[1];
                        } else {
                            qrData = code.data;
                        }
                        console.log("✅ QR Code Detected:", qrData);
                        //decode urlencoded data
                        qrData = decodeURIComponent(qrData);
                        console.log("✅ QR Code Detected:", qrData);
                        //if it starts and ends with " then remove them
                        if (qrData.startsWith('"') && qrData.endsWith('"')) {
                            qrData = qrData.slice(1, -1);
                        }
                        console.log("✅ QR Code Detected:", qrData);
                        //and then replace any internal escaped quotes with double quotes
                        qrData = qrData.replace(/\\"/g, '"');
                        console.log("✅ QR Code Detected:", qrData);
                        try {
                            let parsedData;
                            if (typeof qrData === 'string') {
                                parsedData = JSON.parse(qrData);
                                console.log("🔹 QR Code Data:", parsedData);
                            }
                            console.log("🔹 Parsed Data:", parsedData);
                            console.log("🔹 Session ID:", parsedData.session_id);
                            if (parsedData.session_id) {
                                globalUuid = parsedData.session_id; // ✅ Set UUID first
                                console.log("🔹 Extracted Session ID:", globalUuid);
        
                                // ✅ Delay WebSocket setup slightly to ensure `globalUuid` is fully assigned
                                setTimeout(() => {
                                    if (globalUuid && globalUuid !== "") {
                                        console.log("✅ Starting WebSocket after UUID is set:", globalUuid);
                                        setupWebSocket(globalUuid);
                                    } else {
                                        console.error("❌ Session ID is still undefined, WebSocket cannot start.");
                                    }
                                }, 1000);
        
                                scanning = false;  // ✅ Stop scanning QR code
                                
                                // Wait for capture sequence to complete before sending data
                                await captureSequence();  // ✅ Wait for AprilTag detection sequence to complete
                                
                                // Now aprilTags array should be filled
                                console.log("Sending data to server:", parsedData, globalUuid, aprilTags);
                                sendDataToServer(globalUuid, parsedData, aprilTags);

                            } else {
                                console.error("❌ QR Code does not contain a valid UUID.");
                            }
                        } catch (e) {
                            console.error("Error parsing QR code data:", e);
                            console.log("Raw data:", code.data);
                        }
                    }
                } catch (error) {
                    console.error("❌ Error scanning QR Code:", error);
                }
        
                requestAnimationFrame(scanForQRCode);
            } else {
                requestAnimationFrame(scanForQRCode);
            }
        }
        
                

        async function captureSequence(interval = 100, duration = 500) {
            console.log("📸 Starting AprilTag capture sequence...");

            return new Promise((resolve) => {
                if (!window.apriltag) {
                    console.error("❌ AprilTag detector is not initialized. Retrying...");
                    setTimeout(() => captureSequence(interval, duration).then(resolve), 500);
                    return;
                }

                let frameCaptureMax = duration / interval;
                let frameCaptureCount = 0;
                let frameList = [];

                let captureInterval = setInterval(async () => {
                    if (frameCaptureCount++ >= frameCaptureMax) {
                        clearInterval(captureInterval);
                        console.log("✅ Captured", frameList.length, "frames.");
                        await processImages(frameList);
                        console.log("📌 AprilTags detected:", aprilTags.length);
                        displayCapturedData();
                        stopCamera();
                        resolve(); // Resolve the promise when everything is done
                        return;
                    } else {
                        console.log("📸 Capturing frame:", frameCaptureCount);
                        frameContext.drawImage(video, 0, 0, frameCanvas.width, frameCanvas.height);
                        frameList.push(frameContext.getImageData(0, 0, frameCanvas.width, frameCanvas.height));
                    }
                }, interval);
            });
        }
        

        async function processImages(frameList) {
            let cnt = 0;
            const promises = frameList.map(async (imageData) => {
                console.log("Processing image:", cnt++);
                try {
                    const aprilTagData = await detectAprilTagFromImage(imageData);
                    if (aprilTagData) {
                        aprilTagData.forEach(tag => {
                            aprilTags.push(tag.id);
                        });
                        console.log("Detected AprilTag(s):", aprilTagData);
                    } else {
                        aprilTags.push(-1);
                        console.log("No AprilTag detected.");
                    }
                } catch (error) {
                    console.error("Error processing image:", error);
                }
            });
            // Wait for all promises to resolve
            await Promise.all(promises);
        }

        async function detectAprilTagFromImage(imageData) {
            if (!window.apriltag) {
                throw new Error("AprilTag detector is not initialized. Call `init()` first.");
            }
        
            let imageDataPixels = imageData.data;
            let grayscalePixels = new Uint8Array(frameCanvas.width * frameCanvas.height);
        
            for (let i = 0, j = 0; i < imageDataPixels.length; i += 4, j++) {
                let grayscale = Math.round(
                    (imageDataPixels[i] + imageDataPixels[i + 1] + imageDataPixels[i + 2]) / 3
                );
                grayscalePixels[j] = grayscale;
            }
            //console.log("Grayscale Pixels Sample:", grayscalePixels.slice(0, 50));
            //console.log("Color Pixels Sample:", imageDataPixels.slice(0, 50));
            
            let detections = await window.apriltag.detect(grayscalePixels, frameCanvas.width, frameCanvas.height);
        
            if (detections.length > 0) {
                return detections.map(det => ({
                    id: det.id,
                    center: det.center,
                    corners: det.corners
                }));
            }
        
            return null; // No AprilTag detected
        }

        // Function to send QR and AprilTag data to the server
        async function sendDataToServer(sessionId, qrData, aprilTags) {
            console.log("Sending to server:", sessionId, qrData, aprilTags);
            const url = `/send-message/${sessionId}`;
            console.log("Sending to server:", url);
            const payload = {
                qrData: qrData,
                aprilTags: aprilTags
            };
            console.log("Sending data to server:", payload);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Message sent successfully:", result);
                } else {
                    console.error("Failed to send message:", response.statusText);
                }
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        // Example usage: Call this function after capturing data
        function displayCapturedData() {
            document.getElementById("qr-data").textContent = qrData;
            console.log("QR Data:", qrData);
            document.getElementById("april-tags").textContent = aprilTags;
            console.log("April Tags:", aprilTags);
        }

        function stopCamera() {
            scanning = false;
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
            // Hide camera section
            document.querySelector('.camera-section').style.display = "none";
        }

        function displayCapturedFrame(imageData) {
            let tempCanvas = document.createElement("canvas");
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            let tempCtx = tempCanvas.getContext("2d");
            tempCtx.putImageData(imageData, 0, 0);
        
            // Append to page
            let imageContainer = document.getElementById("image-container");
            if (!imageContainer) {
                imageContainer = document.createElement("div");
                imageContainer.id = "image-container";
                document.body.appendChild(imageContainer);
            }
            //imageContainer.innerHTML = "<h3>Captured Frame</h3>"; // Clear old images
            imageContainer.appendChild(tempCanvas);
        }
    </script>





<script>

 
    function setupWebSocket(sessionId) {
        if (!sessionId) {
            console.error("Session ID is not set. WebSocket cannot be established.");
            return;
        }
    
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const uuid = crypto.randomUUID(); // Generate a unique identifier for this client
        const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}/${uuid}`;
    
        console.log(`Connecting to WebSocket at: ${wsUrl}`);
        window.ws = new WebSocket(wsUrl);
    
        window.ws.onopen = () => console.log("WebSocket connection established");
        window.ws.onmessage = (event) => console.log("Received:", event.data);
        window.ws.onclose = () => console.log("WebSocket connection closed");
        window.ws.onerror = (error) => console.error("WebSocket error:", error);
    }

    let drawing = false;  // Track if the user is drawing
    let lastPoint = null; // Store last known point
    


function getCanvasCoordinates(event, canvas) {
    const rect = canvas.getBoundingClientRect();

    if (event.touches) {
        return {
            x: event.touches[0].clientX - rect.left,
            y: event.touches[0].clientY - rect.top,
        };
    } else {
        return {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top,
        };
    }
}

    function sendCanvasData(event, isPenUp = false) {
        if (!window.ws || window.ws.readyState !== WebSocket.OPEN) return;
    
        if (isPenUp) {
            window.ws.send(JSON.stringify({ type: "signature", pen_up: "true" }));
            return;
        }
    
        const canvas = document.getElementById("signatureCanvas");
        const rect = canvas.getBoundingClientRect();
    
        let x, y;
    
        if (event.touches) {
            x = event.touches[0].clientX - rect.left;
            y = event.touches[0].clientY - rect.top;
        } else {
            x = event.clientX - rect.left;
            y = event.clientY - rect.top;
        }
    
        if (x == null || y == null || isNaN(x) || isNaN(y)) {
            console.warn("❌ Invalid signature coordinates detected.");
            return;
        }
    
        const data = JSON.stringify({ type: "signature", x, y });
    
        window.ws.send(data);
    }
    
    
    function startDrawing(event) {
        event.preventDefault(); // Prevent scrolling on mobile
        drawing = true;
    
        const canvas = document.getElementById("signatureCanvas");
        const ctx = canvas.getContext("2d");
    
        ctx.beginPath();
        const { x, y } = getCanvasCoordinates(event, canvas);
        ctx.moveTo(x, y);
    
        lastPoint = { x, y };
        sendCanvasData(event, false); // ✅ Send first point immediately
        canvas.addEventListener("mousemove", drawOnCanvas);
        canvas.addEventListener("touchmove", drawOnCanvas);
    }


    function drawOnCanvas(event) {
        event.preventDefault();
        if (!drawing) return;
    
        const canvas = document.getElementById("signatureCanvas");
        const ctx = canvas.getContext("2d");
    
        const { x, y } = getCanvasCoordinates(event, canvas);

        if (lastPoint) {
            ctx.lineTo(x, y); 
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    
        lastPoint = { x, y }; // Store last position
        sendCanvasData(event, false);
    }

    // Modify stopDrawing to send a pen up event
    function stopDrawing(event) {
        if (drawing) {
            sendCanvasData(null, true); // Send pen up event
            drawing = false;
            lastPoint = null;
        }
    }
    
    // Continuously send points while finger is moving
    function trackMovement(event) {
        if (!drawing) return;
        sendCanvasData(event, false);
    }
    
    function drawPoint(event) {
        console.log("Drawing point");
        const canvas = document.getElementById("signatureCanvas");
        const ctx = canvas.getContext("2d");
        
        // Get proper canvas coordinates
        const { x, y } = getCanvasCoordinates(event, canvas);
        
        ctx.beginPath();
        ctx.arc(x, y, 1, 0, 2 * Math.PI);
        ctx.fillStyle = "#000";
        ctx.fill();
        
        // Send the point data
        sendCanvasData(event, false);
    }

    // Attach event listeners to capture finger movements
    function setupCanvas() {
        const canvas = document.getElementById("signatureCanvas");
    
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", trackMovement);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseleave", stopDrawing);
        canvas.addEventListener("click", drawPoint);

    
        // Touch events
        canvas.addEventListener("touchstart", (event) => {
            drawPoint(event);
            startDrawing(event);
        });
        canvas.addEventListener("touchmove", trackMovement);
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("touchcancel", stopDrawing);
    }
    
    window.onload = setupCanvas;

    
</script>

<h2>ClientB - Sign Here</h2>
<canvas id="signatureCanvas" width="300" height="200" style="border:1px solid black;"></canvas>
<button id="resetButton">Reset Signature</button>
 
</body>
</html>